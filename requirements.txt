import streamlit as st
import random
import time
import requests
from streamlit_lottie import st_lottie

# --- SAYFA AYARLARI ---
st.set_page_config(page_title="FatoÅŸ Hoca ile Bilim YolculuÄŸu", page_icon="ğŸš€", layout="centered")

# --- LOTTIE ANIMASYON YÃœKLEYÄ°CÄ° ---
# Ä°nternetten hareketli gÃ¶rseller Ã§eker
@st.cache_data
def load_lottieurl(url: str):
    r = requests.get(url)
    if r.status_code != 200:
        return None
    return r.json()

# Animasyon Linkleri (Bilim, BaÅŸarÄ±, Hata)
lottie_bilim = load_lottieurl("https://assets5.lottiefiles.com/packages/lf20_w51pcehl.json")
lottie_dogru = load_lottieurl("https://assets10.lottiefiles.com/packages/lf20_l4xxt7fk.json") # Konfeti
lottie_yanlis = load_lottieurl("https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json") # ÃœzgÃ¼n robot

# --- EÄLENCELÄ° CSS TASARIMI ---
st.markdown("""
    <style>
    /* Google Font Ä°Ã§e Aktar (Ã‡ocuksu Font) */
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');

    /* Genel Sayfa YapÄ±sÄ± */
    .stApp {
        background: linear-gradient(to bottom right, #0f0c29, #302b63, #24243e); /* Uzay TemasÄ± */
        font-family: 'Comic Neue', cursive;
        color: white !important;
    }
    
    h1, h2, h3 {
        font-family: 'Comic Neue', cursive;
        color: #FFD700 !important; /* AltÄ±n SarÄ±sÄ± BaÅŸlÄ±klar */
        text-shadow: 2px 2px 4px #000000;
        text-align: center;
    }

    /* Buton TasarÄ±mÄ± - Oyun DÃ¼ÄŸmesi Gibi */
    .stButton>button {
        width: 100%;
        border-radius: 20px;
        height: 70px;
        background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); /* Parlak Mavi */
        color: white;
        font-weight: bold;
        font-size: 20px;
        border: 3px solid white;
        box-shadow: 0 5px #005cbf;
        transition: all 0.1s;
    }
    /* Butona TÄ±klama Efekti */
    .stButton>button:active {
        box-shadow: 0 2px #005cbf;
        transform: translateY(3px);
    }
    /* Buton Ãœzerine Gelme Efekti */
    .stButton>button:hover {
         background: linear-gradient(to bottom, #ff9a44 0%, #fc6076 100%); /* Turuncu/Pembe */
    }

    /* Bilgi KutularÄ± */
    .bilgi-kutusu {
        background: rgba(255, 255, 255, 0.1); /* YarÄ± saydam */
        backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: 15px;
        border: 2px solid #FFD700;
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    /* YanlÄ±ÅŸ Cevap Titreme Efekti iÃ§in SÄ±nÄ±f */
    .shake {
        animation: shake 0.5s;
        animation-iteration-count: 1;
    }
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    </style>
""", unsafe_allow_html=True)

# --- SORU HAVUZU ---
sorular = [
    {"soru": "GÃ¼neÅŸ sistemindeki EN BÃœYÃœK gezegen hangisidir? ğŸª", "secenekler": ["Mars (KÄ±zÄ±l Gezegen)", "JÃ¼piter (Dev Gaz)", "SatÃ¼rn (HalkalÄ±)", "DÃ¼nya (Evimiz)"], "cevap": "JÃ¼piter (Dev Gaz)"},
    {"soru": "HÃ¼crenin enerji santrali neresidir? âš¡", "secenekler": ["Ribozom", "Ã‡ekirdek (Patron)", "Mitokondri (Enerji)", "Koful (Depo)"], "cevap": "Mitokondri (Enerji)"},
    {"soru": "Kuvvetin birimi nedir? ğŸ’ª", "secenekler": ["Newton (N)", "Pascal (Pa)", "Joule (J)", "Watt (W)"], "cevap": "Newton (N)"},
    {"soru": "Maddenin tanecikleri en Ã§ok hangisinde dans eder (hareketlidir)? ğŸ’ƒ", "secenekler": ["KatÄ± (Buz gibi)", "SÄ±vÄ± (Su gibi)", "Gaz (Buhar gibi)", "Plazma"], "cevap": "Gaz (Buhar gibi)"},
    {"soru": "Hangisi doÄŸa dostu, yenilenebilir enerjidir? ğŸŒ¿", "secenekler": ["KÃ¶mÃ¼r (Kara duman)", "DoÄŸalgaz", "RÃ¼zgar (Pervane)", "Petrol"], "cevap": "RÃ¼zgar (Pervane)"},
    {"soru": "IÅŸÄ±k en hÄ±zlÄ± nerede koÅŸar? ğŸƒâ€â™‚ï¸ğŸ’¨", "secenekler": ["Camda", "Suda", "Uzay BoÅŸluÄŸunda", "Havada"], "cevap": "Uzay BoÅŸluÄŸunda"},
    {"soru": "Limon gibi asitlerin tadÄ± nasÄ±ldÄ±r? ğŸ‹", "secenekler": ["EkÅŸi (YÃ¼z buruÅŸturan)", "AcÄ± (Biber gibi)", "TatlÄ± (Åeker gibi)", "Tuzlu"], "cevap": "EkÅŸi (YÃ¼z buruÅŸturan)"},
    {"soru": "DÃ¼nya'mÄ±zÄ±n gece lambasÄ± olan doÄŸal uydusu nedir? ğŸŒ•", "secenekler": ["GÃ¼neÅŸ", "Ay", "Titan", "Mars"], "cevap": "Ay"},
    {"soru": "AÅŸaÄŸÄ±dakilerden hangisi bir elementtir (Saf maddedir)? ğŸ’", "secenekler": ["Su (H2O)", "Hava (KarÄ±ÅŸÄ±m)", "Demir (Fe)", "Tuz (NaCl)"], "cevap": "Demir (Fe)"},
    {"soru": "DNA (Genetik kodumuz) hÃ¼crenin neresinde saklanÄ±r? ğŸ§¬", "secenekler": ["HÃ¼cre ZarÄ±", "Sitoplazma", "Ã‡ekirdek (Kasa)", "Koful"], "cevap": "Ã‡ekirdek (Kasa)"},
]

# --- OYUN MOTORU ---

# HafÄ±zayÄ± BaÅŸlat
if 'soru_index' not in st.session_state:
    st.session_state.soru_index = 0
    st.session_state.bakiye = 0
    st.session_state.joker_kullanildi = False
    st.session_state.oyun_bitti = False
    st.session_state.son_cevap_durumu = None # "dogru" veya "yanlis" olacak
    random.shuffle(sorular)
    st.session_state.sorular = sorular

# --- YAN MENÃœ: FATOÅ HOCA ---
with st.sidebar:
    st_lottie(lottie_bilim, height=150, key="sidebar_anim")
    st.markdown("### ğŸ‘©â€ğŸ« FatoÅŸ Hoca Diyor ki:")
    
    if st.session_state.bakiye > 3000:
        st.success("Harika gidiyorsun, tam bir bilim insanÄ±sÄ±n! ğŸŒŸ")
    elif st.session_state.bakiye < 0:
        st.warning("Biraz daha dikkatli ol, baÅŸarabilirsin! ğŸ’ª")
    else:
        st.info("YarÄ±ÅŸmaya hoÅŸ geldin! SorularÄ± dikkatli oku. ğŸ‘€")
        
    st.write("---")
    st.metric("ğŸ’° KASA DURUMU", f"{st.session_state.bakiye} TL")

# --- ANA EKRAN ---

# BaÅŸlÄ±k ve Animasyon
col_title1, col_title2 = st.columns([3, 1])
with col_title1:
    st.title("ğŸš€ FATOÅ HOCA Ä°LE BÄ°LÄ°M YARIÅI")
with col_title2:
    st_lottie(lottie_bilim, height=100, key="main_anim")

st.write("") # BoÅŸluk

# Oyun Bitti mi?
if st.session_state.soru_index >= len(st.session_state.sorular):
    st.session_state.oyun_bitti = True

if st.session_state.oyun_bitti:
    st.balloons() # Balonlar uÃ§sun!
    st_lottie(lottie_dogru, height=200, key="finish_anim") # Konfeti animasyonu
    
    st.markdown("<h1 style='color: #4facfe;'>ğŸ‰ OYUN BÄ°TTÄ°! ğŸ‰</h1>", unsafe_allow_html=True)
    st.markdown(f"<div class='bilgi-kutusu' style='font-size: 30px;'>TOPLAM Ã–DÃœLÃœN: {st.session_state.bakiye} TL ğŸ’°</div>", unsafe_allow_html=True)
    
    if st.session_state.bakiye > 5000:
         st.success("ğŸ† MÃœKEMMEL BÄ°R SONUÃ‡! Sen bir dahisin!")
    elif st.session_state.bakiye > 0:
         st.info("ğŸ‘ GÃ¼zel yarÄ±ÅŸtÄ±, tebrikler!")
    else:
         st.error("Pek gÃ¼nÃ¼nde deÄŸildin ama tekrar deneyebilirsin! ğŸ˜Š")

    st.write("")
    if st.button("ğŸ”„ YENÄ°DEN BAÅLA"):
        st.session_state.soru_index = 0
        st.session_state.bakiye = 0
        st.session_state.joker_kullanildi = False
        st.session_state.oyun_bitti = False
        st.session_state.son_cevap_durumu = None
        random.shuffle(sorular)
        st.session_state.sorular = sorular
        st.rerun()

else:
    # Mevcut Soru Verileri
    suanki_soru = st.session_state.sorular[st.session_state.soru_index]
    toplam_soru = len(sorular)
    mevcut_soru_no = st.session_state.soru_index + 1
    
    # Ä°lerleme Ã‡ubuÄŸu (Progress Bar)
    ilerleme = st.progress(0)
    ilerleme.progress(mevcut_soru_no / toplam_soru)

    # Bilgi Paneli (Soru No ve Joker)
    col_info1, col_info2 = st.columns([2, 1])
    with col_info1:
         st.markdown(f"### â“ SORU {mevcut_soru_no} / {toplam_soru}")
    with col_info2:
        if st.session_state.joker_kullanildi:
            st.warning("ğŸš« Joker KullanÄ±ldÄ±")
        else:
            if st.button("ğŸƒ %100 JOKER"):
                st.session_state.joker_kullanildi = True
                # CevabÄ± sÃ¼slÃ¼ bir ÅŸekilde gÃ¶ster
                st.info(f"ğŸ’¡ FatoÅŸ Hoca FÄ±sÄ±ldÄ±yor: Cevap **'{suanki_soru['cevap']}'**")
                st_lottie(lottie_bilim, height=50, key="joker_anim")

    # --- SORU ALANI (BÃ¼yÃ¼k ve Net) ---
    st.markdown(f"""
    <div style='background-color: #24243e; padding: 20px; border-radius: 15px; border: 3px solid #4facfe; text-align: center; margin: 20px 0;'>
        <h2 style='color: white !important; margin:0;'>{suanki_soru['soru']}</h2>
    </div>
    """, unsafe_allow_html=True)

    # --- ÅIKLAR (2x2 DÃ¼zen) ---
    secenekler = suanki_soru['secenekler']
    
    c1, c2 = st.columns(2)
    
    def cevap_ver(secilen_sik):
        if secilen_sik == suanki_soru['cevap']:
            st.session_state.bakiye += 1000
            st.balloons() # DoÄŸruysa balonlar
            st.success("âœ… DOÄRU CEVAP! HarikasÄ±n! (+1000 TL)")
            time.sleep(1.5)
        else:
            st.session_state.bakiye -= 500
            # YanlÄ±ÅŸ cevapta ekranÄ± titreten Ã¶zel HTML/CSS bloÄŸu
            st.markdown("""<div class='shake' style='background-color: #ff4d4d; padding: 15px; border-radius: 10px; text-align: center;'>
                <h3 style='color: white !important;'>âŒ AYYY YANLIÅ OLDU! (-500 TL)</h3>
            </div>""", unsafe_allow_html=True)
            st.error(f"DoÄŸrusu: {suanki_soru['cevap']} olacaktÄ±.")
            time.sleep(2.5) # YanlÄ±ÅŸÄ± okumasÄ± iÃ§in biraz daha uzun bekle
        
        # Sonraki soruya geÃ§
        st.session_state.soru_index += 1
        st.rerun()

    with c1:
        st.write("") # Butonlar arasÄ± boÅŸluk iÃ§in
        if st.button(f"A) {secenekler[0]}"): cevap_ver(secenekler[0])
        st.write("")
        if st.button(f"C) {secenekler[2]}"): cevap_ver(secenekler[2])
        
    with c2:
        st.write("")
        if st.button(f"B) {secenekler[1]}"): cevap_ver(secenekler[1])
        st.write("")
        if st.button(f"D) {secenekler[3]}"): cevap_ver(secenekler[3])
